<!DOCTYPE html>
<html lang="en" class="spectrum spectrum--medium spectrum--light spectrum--express">
  <head>
    <title>Adobe Express Embed SDK Sample</title>
    <link rel="stylesheet" href="node_modules/@spectrum-css/tokens/dist/css/index.css">
    <link rel="stylesheet" href="node_modules/@spectrum-css/page/dist/index-vars.css">
    <link rel="stylesheet" href="node_modules/@spectrum-css/button/dist/index-vars.css">
    <link rel="stylesheet" href="node_modules/@spectrum-css/typography/dist/index-vars.css">
    <link rel="stylesheet" href="node_modules/@spectrum-css/sidenav/dist/index-vars.css">
    <link rel="stylesheet" href="node_modules/@spectrum-css/textfield/dist/index-vars.css">
    <style>
        .sample {
            margin: 3%;
        }
        hr.solid {
            border-top: 2px solid #bbb;
            margin: 2% 0%;
        }
        .spacer {
            margin-bottom: 10px;
        }
        
        /* Validation error styles */
        .validation-error {
            border-color: #666 !important;
        }
        
        .error-message {
            color: #d73a49;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* Disabled button styling */
        .spectrum-Button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
  </head>
  <body>
    <div class="sample spectrum-Typography">
        <h1 class="spectrum-Heading spectrum-Heading--sizeXXL"> Embed SDK: Modules </h1>
        <p class="spectrum-Body spectrum-Body--sizeL" > 
            This sample surfaces <b>three export buttons</b> to the user after a quick action workflow is complete:
        </p>
        <p class="spectrum-Body spectrum-Body--sizeL">1. [Native] <b>Download</b>: Downloads the modified asset to the user's computer.
            <br>2. [Native] <b>Customize</b>: Sends user to an embedded editor to continue editing the modified asset.
            <br>3. [Custom] <b>Save image</b>: Save and display the modified asset on this page. Use the button below to hide the image.
        </p> 
        <hr class="solid"> 

        <h2 class="spectrum-Heading spectrum-Heading--sizeXL"> Text to Image</h2>
        <p class="spectrum-Body spectrum-Body--sizeL">You can also launch the module, and input the prompt once the modal is open.</p>
        <div class="spectrum-Textfield is-focused">
            <label for="textfield-focused" class="spectrum-FieldLabel spectrum-FieldLabel--sizeM">Enter your prompt</label>
            <input id="textfield-focused" type="text" name="field" value="" class="spectrum-Textfield-input">
        </div>
        <div class="spacer"></div>
        <button id="text-to-image" class="spectrum-Button spectrum-Button--fill spectrum-Button--accent spectrum-Button--sizeL" >
            <span class="spectrum-Button-label">Text to Image</span>
        </button>
        <button id="clear" class="spectrum-Button spectrum-Button--outline spectrum-Button--secondary spectrum-Button--sizeL" >
            <span class="spectrum-Button-label">Clear Prompt</span>
        </button>


        <h2 class="spectrum-Heading spectrum-Heading--sizeXL">Edit Image</h2>

        <input type="file" id="fileInput" accept="image/*,video/*"/>
        <button id="reset">Reset</button><p></p>
        <p class="spectrum-Body spectrum-Body--sizeL">Select a file before you launch the module.</p>

        <button id="image-edit" class="spectrum-Button spectrum-Button--fill spectrum-Button--accent spectrum-Button--sizeL" >
            <span class="spectrum-Button-label">Edit Image</span>
        </button>
        
        <button id="clear" class="spectrum-Button spectrum-Button--outline spectrum-Button--secondary spectrum-Button--sizeL" >
            <span class="spectrum-Button-label">Hide</span>
        </button>

        <hr class="solid">
        <h2 class="spectrum-Heading spectrum-Heading--sizeXL">Start From Template</h2>

        <div class="spectrum-Textfield">
            <label for="header-text" class="spectrum-FieldLabel spectrum-FieldLabel--sizeM">Header Text *</label>
            <input id="header-text" type="text" name="header-text"
                value="Jump-start your inspiration with thousands of professionally designed templates"
                placeholder="Jump-start your inspiration with thousands..." class="spectrum-Textfield-input" required>
            <div id="header-text-error" class="error-message">Header text is required</div>
        </div>
        <p></p>

        <div class="spectrum-Checkbox">
            <input type="checkbox" class="spectrum-Checkbox-input" id="hide-search-bar">
            <label class="spectrum-Checkbox-label" for="hide-search-bar">Hide Search Bar</label>
        </div>
        <p></p>

        <div class="spectrum-Textfield">
            <label for="search-query" class="spectrum-FieldLabel spectrum-FieldLabel--sizeM">Search Query</label>
            <input id="search-query" type="text" name="search-query" value="Instagram story"
                class="spectrum-Textfield-input">
            <div id="search-query-error" class="error-message">Search query is required</div>
        </div>
        <p></p>

        <div class="spectrum-Checkbox">
            <input type="checkbox" class="spectrum-Checkbox-input" id="hide-filters">
            <label class="spectrum-Checkbox-label" for="hide-filters">Hide Filters</label>
        </div>
        <p></p>

        <div class="spectrum-Textfield">
            <label for="shortcut-pills" class="spectrum-FieldLabel spectrum-FieldLabel--sizeM">Shortcut Pill
                Terms</label>
            <input id="shortcut-pills" type="text" name="shortcut-pills" value="Social, Business, Events, Personal, Creative"
                class="spectrum-Textfield-input" placeholder="Enter exactly 5 comma-separated terms">
            <div id="shortcut-pills-error" class="error-message">Please enter exactly 5 valid comma-separated terms (alphanumeric only, 1-30 chars each)</div>
        </div>
        <p></p>

         <button id="start-from-template" disabled
             class="spectrum-Button spectrum-Button--fill spectrum-Button--accent spectrum-Button--sizeL">
             <span class="spectrum-Button-label">Start From Template</span>
         </button>
         <button id="reset-template" class="spectrum-Button spectrum-Button--outline spectrum-Button--secondary spectrum-Button--sizeL">
             <span class="spectrum-Button-label">Reset</span>
         </button>

        <img id="image-container" style="visibility:hidden;"/>
        <hr class="solid">
        <h2 class="spectrum-Heading spectrum-Heading--sizeXL"> Other SDK Components</h2>
        <button id="full-editor" class="spectrum-Button spectrum-Button--outline spectrum-Button--primary spectrum-Button--sizeL" >
            <span class="spectrum-Button-label" >Try the full editor</span>
        </button>
        <button id="QA" class="spectrum-Button spectrum-Button--outline spectrum-Button--primary spectrum-Button--sizeL" >
            <span class="spectrum-Button-label" >Try quick actions</span>
        </button>
    </div>
    <script src="https://cc-embed.adobe.com/sdk/v4/CCEverywhere.js"></script>
    <script type="text/javascript" >
        
    (async () => {
        const initializeParams = {
            clientId: 'your-client-id',
            appName: 'V4 Sample',
        }
        const configParams = {
            loginMode: 'delayed'
        }

         /* appImage:  the image container displayed in sample */
        var appImage = document.getElementById('image-container');
        
        const callbacks = {
            onCancel: () => {},
            onPublish: (intent, publishParams) => {
                const localData = { asset: publishParams.asset[0].data}
                if(publishParams.exportButtonId=="save-modified-asset"){
                    appImage.src = localData.asset;
                    appImage.style.visibility="visible";
                }
            },
            onError: (err) => {
                console.error('Error received is', err.toString())
            }
        }

        const {module} = await window.CCEverywhere.initialize(initializeParams, configParams);

        document.getElementById("full-editor").addEventListener('click', () => {
            window.location.href = "https://localhost:8000/";
        });
        document.getElementById("QA").addEventListener('click', () => {
            window.location.href = "https://localhost:8000/quickactions.html";
        });


        /* inputFile: file input picker */
        var inputFile = document.getElementById('fileInput');

        /* base64Asset: base64 representation we pass into QA function */
        var base64Asset; 

        // Text to image prompt
        var inputField = document.getElementById('textfield-focused');

        /* This event listener checks to see if the user uploads a new file 
        and reads it into base64 data type for SDK ingestion later */
        inputFile.addEventListener('change', (e) => {
            const reader = new FileReader();
            // reads file into base 64 data type
            reader.readAsDataURL(e.target.files[0]);
            reader.onload = () => {
                base64Asset = reader.result;
            }
            reader.onerror = (error) => {
                console.log('error', error);
            };
        })

        const exportOptions = [
            {
                id: 'save-modified-asset',
                label: 'Save image',
                action: {
                    target: 'publish'
                },
                style: {
                    uiType: 'button'
                }
            },
            {
                type: 'continue-editing',
                label: 'Continue Editing',
                style: {
                    uiType: 'button'
                },
                options: [
                  {
                        id: 'exportOption1',
                        style: {
                            uiType: 'dropdown'
                        },
                        action: {
                            target: 'express',
                            intent: 'add-icons-and-shapes'
                        }
                  },
                  {
                    id: 'exportOption2',
                    style: {
                        uiType: 'dropdown'
                    },
                    action: {
                        target: 'image-module',
                        intent: 'remove-background'
                    }
                  },
                  {
                    id: 'exportOption3',
                    style: {
                        uiType: 'dropdown'
                    },
                    action: {
                        target: 'express',
                        intent: 'add-images'
                    }
                  },
                  {
                    id: 'exportOption4',
                    style: {
                        uiType: 'dropdown'
                    },
                    action: {
                        target: 'express',
                        intent: 'add-text'
                    }
                  }
                ]
            }
        ];

        // Start From Template functionality
        let templateImageURL = null;
        const setImageURL = (url) => {
            templateImageURL = url;
        }

        const templateExportConfig = [
            {
                id: 'download',
                label: 'Download',
                action: {
                    target: 'download'
                },
                style: {
                    uiType: 'button'
                }
            },
            {
                id: 'save-template-asset',
                label: 'Save Template',
                action: {
                    target: 'publish'
                },
                style: {
                    uiType: 'button'
                }
            }
        ];

        const containerConfig = {
            width: '100%',
            height: '600px',
            showDarkerBackgroundForLoader: true,
            showExpressIconWithText: true
        };

        // validation functions
        const clearValidationErrors = () => {
            document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
        };

        const showValidationError = (fieldId, errorId) => {
            const fieldElement = document.getElementById(fieldId);
            const errorElement = document.getElementById(errorId);
            if (fieldElement && errorElement) {
                fieldElement.classList.add('validation-error');
                errorElement.classList.add('show');
            }
        };

        const validateTemplateForm = () => {
            clearValidationErrors();
            let isValid = true;

            // Check header text
            const headerText = document.getElementById('header-text').value.trim();
            if (!headerText) {
                showValidationError('header-text', 'header-text-error');
                isValid = false;
            }

            // Check search query is not empty
            const searchQuery = document.getElementById('search-query').value.trim();
            if (!searchQuery) {
                showValidationError('search-query', 'search-query-error');
                isValid = false;
            }

            
            // Check shortcut pills (exactly 5)
            const pillsInput = document.getElementById('shortcut-pills').value.trim();
            const pills = pillsInput ? pillsInput.split(',').map(p => p.trim()).filter(p => p) : [];
            if (pills.length !== 5) {
                showValidationError('shortcut-pills', 'shortcut-pills-error');
                isValid = false;
            }

            return isValid;
        };

        const updateButtonState = () => {
            const button = document.getElementById('start-from-template');
            if (button) button.disabled = !validateTemplateForm();
        };
    
        const getAllowedFileTypes = () => {
            const allowedFileTypes = ['image/png', 'image/jpeg'];
            return {allowedFileTypes};
        }

        

        const textToImageModule = () => {
            let appConfig = {
                promptText: (document.getElementById('textfield-focused').value),
                callbacks: callbacks
            }
            // The export options defined for the Text to Image module don't appear until the user selects a generative image
            let exportConfig = exportOptions;
            module.createImageFromText(appConfig, exportConfig);
        }

        const imageEditingModule = () => {
            const docConfig = {
                asset: {
                    data: base64Asset,
                    type: 'image',
                    dataType: 'base64'
                }
            }
            let appConfig = { callbacks: callbacks };
            let exportConfig = exportOptions;
            module.editImage(docConfig, appConfig, exportConfig);
        }

         const startFromTemplateModule = () => {
                if (!validateTemplateForm()) return;

                 // Get values from form inputs
                const headerText = document.getElementById('header-text').value.trim();
                const searchQuery = document.getElementById('search-query').value;
                const hideSearchBar = document.getElementById('hide-search-bar').checked;
                const hideFilters = document.getElementById('hide-filters').checked;
                const shortcutPills = document.getElementById('shortcut-pills').value.split(',').map(p => p.trim());


            let appConfig = {
                    colorTheme: "light",
                    contentBrowseConfig: {
                        headerText,
                        searchQuery,
                        hideSearchBar,
                        hideFilters,
                        shortcutPillTerms: shortcutPills,
                        categoriesConfig: [{ "category": "templates" }] // Use "photos" to launch with photos
                    },
                    callbacks: {
                        onPublish: (intent, publishParams) => {
                            appImage.src = publishParams.asset[0].data;
                            appImage.style.visibility = "visible";
                            setImageURL(publishParams.asset[0].data);
                        },
                        onIntentChange: () => ({ exportConfig: templateExportConfig })
                    }
                };

                try {
                    module.startFromContent(appConfig, null, containerConfig);
                } catch (error) {
                    console.error('Error launching template module:', error);
                    alert('Failed to launch template browser. Please try again.');
                }
            };

        // Button event listeners 

        document.getElementById('text-to-image').addEventListener('click', () => {
            textToImageModule();
        });

        document.getElementById('image-edit').addEventListener('click', () => {
            imageEditingModule();
        });

        // Event listeners for real-time validation
        ['header-text', 'search-query', 'shortcut-pills'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateButtonState);
        });
        
        ['hide-search-bar', 'hide-filters'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', updateButtonState);
        });

        setTimeout(updateButtonState, 100);

        document.getElementById('start-from-template').addEventListener('click', startFromTemplateModule);

        document.getElementById('reset-template').addEventListener('click', () => {
            clearValidationErrors();
            document.getElementById('header-text').value = "Jump-start your inspiration with thousands of professionally designed templates";
            document.getElementById('search-query').value = "Instagram story";
            document.getElementById('hide-search-bar').checked = false;
            document.getElementById('hide-filters').checked = false;
            document.getElementById('shortcut-pills').value = "Social, Business, Events, Personal, Creative";
            
            if (appImage) {
                appImage.src = null;
                appImage.style.visibility = "hidden";
                templateImageURL = null;
            }
            
            updateButtonState();
        });

        document.getElementById('clear').addEventListener('click', () => {
            appImage.src=null;
            appImage.style.visibility="hidden";
            inputField.value = '';

        })

        document.getElementById('reset').addEventListener('click', () => {
            base64Asset = null;
            appImage.src = null;
        })
    })();
    </script>
  </body>
</html>
